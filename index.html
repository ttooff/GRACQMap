<!DOCTYPE html>
<html>
  <head>
    <title>GRACQ Hesbaye - Vid√©o Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" integrity="sha256-kLaT2GOSpHechhsozzB+flnD+zUyjE2LlfWPgU04xyI=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js" integrity="sha256-WBkoXOwTeyKclOHuWtc+i2uENFpDZ9YPdf5Hf+D7ewM=" crossorigin="">
    </script>
    <script src="https://player.vimeo.com/api/player.js"></script>
  </head>

  <body>
    <style>
      body {
        padding: 0;
        margin: 0;
        overflow: hidden;
      }

      html,
      body {
        height: 100%;
        width: 100%;
      }

      .row {
        display: flex;
        height: 100%;
      }

      .column {
        flex: 50%;
      }

      #map {
        height: 100%;
        width: 100%;
      }

      #player {
        position: relative;
        width: 100%;
        padding-top: 100%;
      }

      #player iframe {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
      }

      .my-div-icon {
        background-color: transparent;
        font-size: 16px;
        color: white;
        text-align: center;
      }

    </style>

    <div class="row">
      <div class="column">
        <div id="map"></div>
      </div>
      <div class="column">
        <div id="player"></div>
      </div>
    </div>

    <script>
      var coords = [50.70513595799738, 5.271691432079298]; // the geographic center of our map
      var zoomLevel = 13; // the map scale. See: http://wiki.openstreetmap.org/wiki/Zoom_levels

      var map = L.map('map').setView(coords, zoomLevel);

      L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
      }).addTo(map);

      var gpx = 'GH030798_1_GPS5.gpx';
      var gpxData;

      var clickIndex;

      // Vimeo player
      var vimeoOptions = {
        id: 816325469,
        frameborder: 0,
        background: true
      };
      var player = new Vimeo.Player('player', vimeoOptions);
      var videoDuration;
      player.getDuration().then(function(seconds) {
        videoDuration = seconds;
      });

      function findPointIdxOnPolyline(track, latlng) {
        let prevDiffLat = prevDiffLng = 99999;
        let closestIdx = 0;
        for (var i = 0; i < track.length; i++) {
          var latTmp = trkpts[i].getAttribute('lat');
          var lonTmp = trkpts[i].getAttribute('lon');
          var diffLat = Math.abs(latTmp - latlng.lat);
          var diffLng = Math.abs(lonTmp - latlng.lng);
          if (diffLat + diffLng < prevDiffLat + prevDiffLng) {
            prevDiffLat = diffLat;
            prevDiffLng = diffLng;
            closestIdx = i;
          }
        }
        return closestIdx;
      }

      // Load data from GPX file
      function loadGPXFile(filename) {
        var xhr = new XMLHttpRequest();
        xhr.open("GET", filename, false);
        xhr.send();
        if (xhr.readyState === 4 && xhr.status === 200) {
          var parser = new DOMParser();
          var xmlDoc = parser.parseFromString(xhr.responseText, "text/xml");
          return xmlDoc.getElementsByTagName('trkpt');
        } else {
          throw new Error("Failed to load GPX file: " + filename);
        }
      }

      var clickPN = '';
      var trkpts = loadGPXFile('GH030798_1_GPS5.gpx');

      async function addGeoJson() {
        const response = await fetch("PNall.geojson");
        const data = await response.json();

        L.geoJson(data, {
          style: {
            color: 'green',
            weight: 6,
            opacity: 1
          },
          pointToLayer: function(feature, latlng) {
            return L.circleMarker(latlng, {
              radius: 12,
              color: 'green',
              fillColor: 'green',
              fillOpacity: 1
            });
          }
        }).addTo(map);

        L.geoJson(data, {
          style: {
            color: 'green',
            weight: 6,
            opacity: 1
          },
          pointToLayer: function(feature, latlng) {
            return L.marker(latlng, {
              icon: L.divIcon({
                className: 'my-div-icon',
                html: feature.properties.rcn_ref,
                iconSize: [24, 24],
                iconAnchor: [12, 12]
              })
            }).on('click', function(e) {
              clickPN = feature.properties.rcn_ref;
            });
          }
        }).addTo(map).on('click', function(e) {
          // Find the index of the clicked point on the polyline
          var pointIndex = findPointIdxOnPolyline(trkpts, e.latlng);
          // Get the time of the clicked point and calculate the time in seconds
          var timeNew = trkpts[pointIndex].getElementsByTagName('time')[0].textContent;
          var timeNewSec = new Date(timeNew).getTime() / 1000 - startTimeSec;
          // Seek the video player to the new time and log the time to the console
          player.setCurrentTime(timeNewSec);
          // Pause video if clicked on a PN
          if (clickPN !== '') {
            player.pause();
            clickPN = '';
          } else {
            player.play();
          };
          //console.log(`New video time: ${timeNewSec}`);
        });
      }

      addGeoJson();

      var trkpt = trkpts[0];
      var time = trkpt.getElementsByTagName('time')[0].textContent;
      var lat = trkpt.getAttribute('lat');
      var lon = trkpt.getAttribute('lon');
      const startTimeSec = new Date(time).getTime() / 1000;

      var marker = new L.Marker([lat, lon]);
      map.addLayer(marker);

      var tPlayer;
      var tPrev = 0;
      var cnt = 0;
      var timeSec = 0;

      // Update marker every 25ms
      setInterval(showPlaytime, 25);

      function showPlaytime() {
        player.getCurrentTime().then(function(seconds) {
          tPlayer = seconds;
        });

        // Reset GPX timer if video player went back
        if (tPlayer < tPrev) {
          timeSec = 0;
          cnt = 0;
        }
        //console.log(`Video time: ${t}, GPX time: ${timeSec}, cnt: ${cnt}`);

        while (timeSec <= tPlayer && cnt < trkpts.length - 1) {
          cnt = cnt + 1;
          trkpt = trkpts[cnt];
          time = trkpt.getElementsByTagName('time')[0].textContent;
          lat = trkpt.getAttribute('lat');
          lon = trkpt.getAttribute('lon');
          timeSec = new Date(time).getTime() / 1000 - startTimeSec;
        }
        tPrev = tPlayer;

        map.removeLayer(marker);
        marker = new L.Marker([lat, lon]);
        map.addLayer(marker);
      }
    </script>
  </body>
</html>
